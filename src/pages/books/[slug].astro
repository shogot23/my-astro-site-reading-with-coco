---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { genreLabel } from '../../lib/genres';
import { formatDate } from '../../lib/date';

export async function getStaticPaths() {
  const books = await getCollection('books');
  return books.map((book) => ({ params: { slug: book.slug }, props: { book } }));
}

const { book } = Astro.props;
const { Content } = await book.render();
const photos = (await getCollection('photos')).filter((photo) => photo.data.bookSlug === book.slug);
const videos = (await getCollection('videos')).filter((video) => video.data.bookSlug === book.slug);
---

<BaseLayout title={`${book.data.title} | 読書ログ with Coco`}>
  <article>
    <h1>{book.data.title}</h1>
    <p class="meta">{book.data.author ?? '著者不明'} ・ {formatDate(book.data.pubDate)} ・ {genreLabel(book.data.genre)}</p>

    <section style="margin-top:2rem;" class="card">
      <img class="thumb" style="aspect-ratio: 5 / 3;" src={book.data.coverImage} alt={book.data.title} />
      <div class="card-body">
        <h2>① 本情報</h2>
        <p>{book.data.summary}</p>
        {book.data.rating && <p>評価: {book.data.rating} / 5</p>}
      </div>
    </section>

    <section style="margin-top:2rem;">
      <h2>② 本 + ココ写真ギャラリー</h2>
      <div class="grid cards-3">
        {photos.map((photo) => (
          <figure class="card" style="margin:0;">
            <img class="thumb" src={photo.data.image} alt={photo.data.title} />
            <figcaption class="card-body">
              <strong>{photo.data.title}</strong>
              <div class="meta">{formatDate(photo.data.date)}</div>
              {photo.data.notes && <p>{photo.data.notes}</p>}
            </figcaption>
          </figure>
        ))}
      </div>
    </section>

    <section style="margin-top:2rem;">
      <h2>③ Sora2動画</h2>
      <div class="grid" style="gap:1rem;">
        {videos.map((video) => (
          <div class="card">
            <div class="card-body">
              <h3>{video.data.title}</h3>
              {video.data.url.includes('youtube.com/embed') ? (
                <iframe
                  width="100%"
                  height="380"
                  src={video.data.url}
                  title={video.data.title}
                  loading="lazy"
                  style="border:0;border-radius:12px;"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                ></iframe>
              ) : (
                <p><a href={video.data.url} target="_blank" rel="noopener noreferrer">動画を見る</a></p>
              )}
            </div>
          </div>
        ))}
      </div>
    </section>

    <section style="margin-top:2rem;">
      <h2>④ インフォグラフィック画像</h2>
      <div class="grid cards-3">
        {book.data.infographics.map((img) => (
          <img class="card" style="width:100%;aspect-ratio: 16 / 9; object-fit: cover;" src={img} alt={`${book.data.title}のインフォグラフィック`} />
        ))}
      </div>
    </section>

    <section style="margin-top:2rem;" class="card">
      <div class="card-body">
        <h2>⑤ 感想（Markdown本文）</h2>
        <Content />
      </div>
    </section>
  </article>
</BaseLayout>
